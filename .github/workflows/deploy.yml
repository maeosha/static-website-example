name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üîÑ Pulling Docker image..."
            
            # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GHCR (–æ–±—Ä–∞–∑ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
            echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –ø—Ä–æ–µ–∫—Ç–æ–º
            cd /home/maeosha/labs/devops/lab4/static-website-example

            # –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π –æ–±—Ä–∞–∑ (—á—Ç–æ–±—ã compose –ø–æ–¥—Ö–≤–∞—Ç–∏–ª)
            docker pull ghcr.io/${{ github.repository }}:latest

            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ç–µ–∫ —á–µ—Ä–µ–∑ compose
            docker compose down || true
            docker compose up -d

            echo "‚úÖ Deployment finished with Docker Compose"
